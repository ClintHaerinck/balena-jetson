From 7f8ae87c2664543f10ec076b046d3a158fa80e8f Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Thu, 4 Feb 2021 09:42:45 +0100
Subject: [PATCH] imx477: Port patch for photon-nano

This is a port of the driver changes from
https://github.com/RidgeRun/NVIDIA-Jetson-IMX477-RPIV3/blob/453e31091dcbc54f57979ad9b5473e962d6bd46a/patches_nano/4.4.1_evm_imx477-v0.1.0.patch#L1927

Upstream-status: Inappropriate[configuration]
Signed-off-by: Alexandru Costache <alexandru@balena.io>
---
 nvidia/drivers/media/i2c/imx477.c | 21 ++++++++++++++++-----
 1 file changed, 16 insertions(+), 5 deletions(-)

diff --git a/nvidia/drivers/media/i2c/imx477.c b/nvidia/drivers/media/i2c/imx477.c
index 8f436bb1ee68..da4f7157473a 100644
--- a/nvidia/drivers/media/i2c/imx477.c
+++ b/nvidia/drivers/media/i2c/imx477.c
@@ -368,9 +368,9 @@ static int imx477_power_on(struct camera_common_data *s_data)
 			gpio_set_value(pw->reset_gpio, 1);
 	}
 
-	/* Need to wait for t4 + t5 + t9 + t10 time as per the data sheet */
-	/* t4 - 200us, t5 - 21.2ms, t9 - 1.2ms t10 - 270 ms */
-	usleep_range(300000, 300100);
+	/* Need to wait for t4 + t5 + t9 time as per the data sheet */
+	/* t4 - 200us, t5 - 21.2ms, t9 - 1.2ms */
+	usleep_range(23000, 23100);
 
 	pw->state = SWITCH_ON;
 
@@ -637,16 +637,23 @@ static struct camera_common_sensor_ops imx477_common_ops = {
 static int imx477_board_setup(struct imx477 *priv)
 {
 	struct camera_common_data *s_data = priv->s_data;
+	struct camera_common_pdata *pdata = s_data->pdata;
 	struct device *dev = s_data->dev;
 	u8 reg_val[2];
 	int err = 0;
 
-	// Skip mclk enable as this camera has an internal oscillator
+	if (pdata->mclk_name) {
+		err = camera_common_mclk_enable(s_data);
+		if (err) {
+			dev_err(dev, "error turning on mclk (%d)\n", err);
+			goto done;
+		}
+	}
 
 	err = imx477_power_on(s_data);
 	if (err) {
 		dev_err(dev, "error during power on sensor (%d)\n", err);
-		goto done;
+		goto err_power_on;
 	}
 
 	/* Probe sensor model id registers */
@@ -676,6 +683,10 @@ static int imx477_board_setup(struct imx477 *priv)
 err_reg_probe:
 	imx477_power_off(s_data);
 
+err_power_on:
+	if (pdata->mclk_name)
+		camera_common_mclk_disable(s_data);
+
 done:
 	return err;
 }
-- 
2.17.1

